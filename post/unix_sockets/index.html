<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Sockets - hartje.io</title><link rel=preconnect href=https://fonts.gstatic.com><link href="https://fonts.googleapis.com/css2?family=Archivo:wght@900&family=IBM+Plex+Mono&family=Source+Sans+Pro&display=swap" rel=stylesheet><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css integrity="sha512-NhSC1YmyruXifcj/KFRWoC561YpHpc5Jtzgvbuzx5VozKpWvQ+4nXhPdFgmx8xqexRcpAglTj9sIBWINXa8x5w==" crossorigin=anonymous referrerpolicy=no-referrer><link rel=stylesheet href=https://hartje.io/main.min.ca27cd1beef57d3c8cca0d7cf368ad9a6b5faf27595692f5a9411cf96a1392ca.css><link rel=stylesheet href=/css/custom.css><head><body><header><div class=content><div class=left><a href=https://hartje.io/><h1>hartje.io</h1></a></div><div class=right><div class=links><a href=/post/><span>Posts</span></a>
<a href=/about/><span>About</span></a></div><a href=https://hartje.io/><img class=pfp src=https://hartje.io/images/avatar.jpeg></img></a></div></div><hr></header><main><article><time datetime="2022-03-04 10:44:43 -0600 -0600">Mar 4, 2022</time><h1>Sockets</h1><section class=body><h2 id=summary>Summary</h2><p>If you&rsquo;ve ever used <code>netstat</code>, or gone to a website on OSX or Linux (or Windows for that matter) without a background in C (or perhaps systems programming), you may have struggled to fully appreciate the content there in. Or maybe you are just curious to know how <code>sockets</code> work in *nix.</p><p><code>sockets</code> are a form of <code>IPC</code>, or inter process communication, allowing processes to bidirectionally share information with other processes. See other kinds of IPC in <a href=https://beej.us/guide/bgipc/html/multi/index.html>Beej&rsquo;s Guide to Unix IPC</a>.</p><p><code>sockets</code> are commonly referred to by their <em>Address Family</em>, seen in constants such as <code>AF_UNIX</code>, or <code>AF_LOCAL</code>, representing local sockets specifically. You might also want to know about <em>Protocol Family</em>, seen in constants such as <code>PF_UNIX</code> and <code>PF_LOCAL</code>.</p><p>Valid <code>socket</code> types that should be known are:</p><table><thead><tr><th>type</th><th>description</th></tr></thead><tbody><tr><td><code>SOCK_STREAM</code></td><td>A stream oriented packet used for TCP</td></tr><tr><td><code>SOCK_DGRAM</code></td><td>datagram oriented packet, no reordering, used for UDP</td></tr><tr><td><code>SOCK_RAW</code></td><td>Provides access to internal network protocols and interfaces. Only available to super-user</td></tr><tr><td><code>SOCK_SEQPACKET</code></td><td>A sequence-packet socket that is connection oriented, delivering messages in the order sent</td></tr></tbody></table><p>You can learn more about various types of valid <code>sockets</code> on the man page for the socket SystemCall:</p><p><a href=https://man7.org/linux/man-pages/man2/socket.2.html>https://man7.org/linux/man-pages/man2/socket.2.html</a></p><p>Now that we&rsquo;ve discussed what <code>sockets</code> are, and some of the well known constants that sockets use, let&rsquo;s look at the example in the man page.</p><h3 id=unix-socket-example>Unix Socket Example</h3><p>The given snippet in the man page is a bit terse, but practical:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>       <span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;sys/socket.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>       <span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;sys/un.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>       unix_socket <span style=color:#f92672>=</span> socket(AF_UNIX, type, <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>       error <span style=color:#f92672>=</span> socketpair(AF_UNIX, type, <span style=color:#ae81ff>0</span>, <span style=color:#66d9ef>int</span> <span style=color:#f92672>*</span>sv);
</span></span></code></pre></div><p>In the example above, we import the definitions for socket and unix domain sockets, then construct a unix_socket, and assign error the exit code of calling <code>socketpair</code>.</p><p>It is helpful to consult the manual, let&rsquo;s take a look at the two syscall signatures from their respective man pages:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>socket</span>(<span style=color:#66d9ef>int</span> domain, <span style=color:#66d9ef>int</span> type, <span style=color:#66d9ef>int</span> protocol);
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>socketpair</span>(<span style=color:#66d9ef>int</span> domain, <span style=color:#66d9ef>int</span> type, <span style=color:#66d9ef>int</span> protocol, <span style=color:#66d9ef>int</span> sv[<span style=color:#ae81ff>2</span>]);
</span></span></code></pre></div><ul><li><a href=https://man7.org/linux/man-pages/man2/socket.2.html>socket</a></li><li><a href=https://man7.org/linux/man-pages/man2/socketpair.2.html>socketpair</a></li></ul><p>Using what we&rsquo;ve learned about valid types, we can construct a simple program that creates a socket, and prints its file descriptors or any relevant error:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;stdio.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;sys/socket.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;sys/un.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>main</span>()
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> unix_socket, error;
</span></span><span style=display:flex><span>    <span style=color:#75715e>// socket vector, sv, is a vector pointer to two file descriptors
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// representing new sockets for server and client bindings
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>int</span> <span style=color:#f92672>*</span>sv[<span style=color:#ae81ff>2</span>];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    unix_socket <span style=color:#f92672>=</span> socket(AF_UNIX, SOCK_DGRAM, <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>    <span style=color:#75715e>// socketpair below is constructed for the OSX variant. The linux variant has a different signature, instead use:
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// error = socketpair(AF_UNIX, 0, *sv)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    error <span style=color:#f92672>=</span> socketpair(AF_UNIX, SOCK_DGRAM, <span style=color:#ae81ff>0</span>, <span style=color:#f92672>*</span>sv);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (error <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      printf(<span style=color:#e6db74>&#34;Encountered error: %d</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, error);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> error;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    printf(<span style=color:#e6db74>&#34;Socket descriptor: %d</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, unix_socket);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Compiling and running our example can be done by running:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>clang -o socket ./socket.c; ./socket
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Socket descriptor: <span style=color:#ae81ff>3</span>
</span></span></code></pre></div><p>Ok, so we created a socket, and it returned a descriptor, <code>3</code>. What does that mean?</p><p>You are likely familiar with file descriptors 0, 1, 2 if you&rsquo;ve ever redirected output. They are <code>stdin</code>, <code>stdout</code>, and <code>stderr</code>.</p><h2 id=references>References</h2><ol><li><a href=https://beej.us/guide/bgipc/html/multi/index.html>Beej&rsquo;s Guide to Unix IPC</a></li><li><a href=https://man7.org/linux/man-pages/man7/unix.7.html>unix-7 man page</a></li><li><a href=https://man7.org/linux/man-pages/man2/socket.2.html>socket-2 man page</a></li><li><a href=https://en.wikipedia.org/wiki/Unix_domain_socket>unix domain socket wikipedia</a></li><li><a href=https://serverfault.com/questions/124517/what-is-the-difference-between-unix-sockets-and-tcp-ip-sockets>What&rsquo;s the difference between Unix sockets and TCP/IP sockets</a></li><li><a href="https://en.wikipedia.org/wiki/File_descriptor#:~:text=On%20Linux%2C%20the%20set%20of,%2Ffd%2F2%20is%20stderr%20.">File Descriptors</a></li></ol></section><div class=tags><li><a href=https://hartje.io/tags/c>#C</a></li><li><a href=https://hartje.io/tags/unix>#Unix</a></li></div><div class=next-and-prev><a href=https://hartje.io/post/hugo/ class=prev>Previous Post<svg width="18" height="10" xmlns="http://www.w3.org/2000/svg" class="icon icon-arrow-left"><path d="M13.922 5.636 9.055 9.455l.72.545C12.892 7.788 14.606 6.758 18 5l-1.134-.585C14.177 3.007 12.496 1.952 9.774.0l-.72.545 4.868 3.819H0v1.272h13.922z" fill-rule="nonzero"/></svg></a></div><div id=disqus_thread></div><script type=text/javascript>(function(){if(window.location.hostname=="localhost")return;var t,e=document.createElement("script");e.type="text/javascript",e.async=!0,t="hartje-dot-io",e.src="//"+t+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)})()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com/ class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></article></main><hr><footer></footer><br></body></html>